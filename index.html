<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Video to GIF + GIF/Lottie Converter</title>
<link rel="icon" type="image/png" href="favicon.png" />
<style>
  body { background:#121212; color:#e0e0e0; font-family:'Segoe UI',sans-serif; padding:2rem; margin:0; display:flex; justify-content:center; }
  .card { background:#1e1e1e; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.5); padding:2rem; width:90%; max-width:700px }
  h2,h3 { margin:0 0 1rem; color:#fafafa }
  .section { margin-bottom:1.5rem }
  input, button { font-size:1rem; margin-right:.5rem; margin-top:.3rem; }
  input[type="text"], input[type="number"] {
    padding:.4rem; border-radius:4px; border:1px solid #555; background:#2b2b2b; color:#fff;
    vertical-align: middle;
  }
  button {
    background:#2196f3; border:none; border-radius:6px; color:#fff;
    cursor:pointer; padding:.6rem 1.2rem; transition:background .2s;
    vertical-align: middle;
  }
  button:disabled { background:#555; cursor:not-allowed }
  button:hover:not(:disabled) { background:#1976d2 }
  #progressContainer { display:none; margin:1rem 0 }
  #progressBar { width:100%; height:1rem }
  #status { margin-top:.5rem; text-align:center; font-size:.9rem }
  img, video, #lottieContainer {
    display:block; width:100%; margin:.5rem 0; border:1px solid #333;
    border-radius:6px; background:transparent;
  }
  #lottieContainer { height:300px; background:#000 }
  .footer { margin-top:2rem; text-align:center; font-size:.9rem; color:#888 }
  .footer a { color:#2196f3; text-decoration:none }
</style>
</head>
<body>
<div class="card">
  <h2>Video to GIF + GIF/Lottie Converter</h2>

  <div class="section">
    <input type="file" id="fileInput" accept=".gif,.mp4,.webm,.json,.mov,.avi,.mkv" />
    <input type="text" id="fileNameInput" placeholder="Base filename" value="animation" />
  </div>

  <div class="section">
    <label>Frames: <input type="number" id="frameCountInput" value="15" min="1" max="60" /></label>
    <label>Scale %: <input type="number" id="scaleInput" value="50" min="10" max="100" /></label>
  </div>

  <div class="section">
    <button id="toGifBtn" disabled>Convert to GIF</button>
    <button id="toLottieBtn" disabled>Convert to Lottie</button>
    <button id="toVideoBtn" disabled>Convert to Video</button>
    <button id="resetBtn">Reset All</button>
  </div>

  <div id="progressContainer">
    <progress id="progressBar" max="100" value="0"></progress>
    <div id="status">Waiting…</div>
  </div>

  <div class="section">
    <h3>Preview</h3>
    <img id="gifPreview" style="display:none" alt="GIF Preview" />
    <video id="videoPreview" controls style="display:none; max-height:300px;"></video>
    <div id="lottieContainer" style="display:none"></div>
  </div>

  <div class="footer">
    Created by Abdul Rehman Khan —  
    <a href="https://www.linkedin.com/in/developerark/" target="_blank">LinkedIn Profile</a>
  </div>
</div>

<script type="module">
  import { parseGIF, decompressFrames } from 'https://esm.sh/gifuct-js@2.1.2';
  import lottie from 'https://esm.sh/lottie-web';

  const fileInput       = document.getElementById('fileInput');
  const fileNameInput   = document.getElementById('fileNameInput');
  const frameCountInput = document.getElementById('frameCountInput');
  const scaleInput      = document.getElementById('scaleInput');
  const toGifBtn        = document.getElementById('toGifBtn');
  const toLottieBtn     = document.getElementById('toLottieBtn');
  const toVideoBtn      = document.getElementById('toVideoBtn');
  const resetBtn        = document.getElementById('resetBtn');
  const progressWrap    = document.getElementById('progressContainer');
  const progressBar     = document.getElementById('progressBar');
  const statusText      = document.getElementById('status');
  const gifPreview      = document.getElementById('gifPreview');
  const videoPreview    = document.getElementById('videoPreview');
  const lottieContainer = document.getElementById('lottieContainer');

  const MAX_FILE_SIZE = 30 * 1024 * 1024; // 30MB max
  const FPS = 10;

  let fileType = null, fileData = null, lottieData = null, gifFrames = null, videoFrames = [];

  // Load gif.js dynamically & set worker path (host gif.worker.js locally at ./js/gif.worker.js)
  let GIF = null;
  const gifScript = document.createElement('script');
  gifScript.src = "https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.min.js";
  gifScript.onload = () => {
    GIF = window.GIF;
    console.log('GIF.js loaded');
  };
  document.head.appendChild(gifScript);

  function resetAll() {
    gifPreview.src = '';
    gifPreview.style.display = 'none';
    videoPreview.src = '';
    videoPreview.style.display = 'none';
    lottieContainer.innerHTML = '';
    lottieContainer.style.display = 'none';
    toGifBtn.disabled = true;
    toLottieBtn.disabled = true;
    toVideoBtn.disabled = true;
    progressWrap.style.display = 'none';
    progressBar.value = 0;
    statusText.textContent = 'Waiting…';
    fileType = null;
    fileData = null;
    gifFrames = null;
    videoFrames = [];
    lottieData = null;
  }

  // Show preview and prepare for conversions
  fileInput.addEventListener('change', async () => {
    resetAll();
    const file = fileInput.files[0];
    if (!file) return;

    if (file.size > MAX_FILE_SIZE) {
      alert("File too large! Max 30 MB allowed.");
      fileInput.value = "";
      return;
    }

    const ext = file.name.split('.').pop().toLowerCase();
    fileType = ext;
    fileData = file;

    if (ext === 'gif') {
      gifPreview.src = URL.createObjectURL(file);
      gifPreview.style.display = 'block';

      const buf = await file.arrayBuffer();
      const parsed = parseGIF(buf);
      gifFrames = decompressFrames(parsed, true);

      toGifBtn.disabled = true;
      toLottieBtn.disabled = false;
      toVideoBtn.disabled = false;
      statusText.textContent = 'GIF loaded, ready to convert';

    } else if (ext === 'json') {
      try {
        const jsonText = await file.text();
        lottieData = JSON.parse(jsonText);
      } catch {
        alert('Invalid Lottie JSON file.');
        resetAll();
        return;
      }
      lottieContainer.style.display = 'block';
      lottie.loadAnimation({
        container: lottieContainer,
        renderer: 'svg',
        loop: true,
        autoplay: true,
        animationData: lottieData
      });

      toGifBtn.disabled = false;
      toLottieBtn.disabled = true;
      toVideoBtn.disabled = false;
      statusText.textContent = 'Lottie loaded, ready to convert';

    } else if (['mp4','webm','mov','avi','mkv'].includes(ext)) {
      videoPreview.src = URL.createObjectURL(file);
      videoPreview.style.display = 'block';

      toGifBtn.disabled = false;
      toLottieBtn.disabled = false;
      toVideoBtn.disabled = false;

      statusText.textContent = 'Video loaded, ready to convert';
    } else {
      alert('Unsupported file type');
      resetAll();
      return;
    }
  });

  // Auto download helper
  function autoDownload(blob, filename) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Video to GIF conversion: extract frames and encode GIF client-side
  async function videoToGif(file) {
    return new Promise((resolve, reject) => {
      const video = document.createElement('video');
      video.src = URL.createObjectURL(file);
      video.crossOrigin = "anonymous";
      video.muted = true;
      video.playsInline = true;

      video.addEventListener('loadeddata', () => {
        const duration = video.duration;
        const fps = 10;
        const totalFrames = Math.min(Math.floor(duration * fps), 50); // limit max frames to 50 for performance

        const canvas = document.createElement('canvas');
        const scale = parseFloat(scaleInput.value) / 100;
        canvas.width = video.videoWidth * scale;
        canvas.height = video.videoHeight * scale;
        const ctx = canvas.getContext('2d');

        const gif = new GIF({
          workers: 2,
          quality: 10,
          width: canvas.width,
          height: canvas.height,
          workerScript: './js/gif.worker.js' // local worker, must host this file
        });

        let currentFrame = 0;

        function captureFrame() {
          if (currentFrame > totalFrames) {
            gif.render();
            return;
          }
          video.currentTime = currentFrame / fps;
        }

        video.addEventListener('seeked', () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          gif.addFrame(ctx, {delay: 100});
          currentFrame++;
          statusText.textContent = `Capturing frame ${currentFrame} of ${totalFrames}`;
          progressBar.value = (currentFrame / totalFrames) * 100;

          if (currentFrame <= totalFrames) {
            captureFrame();
          }
        });

        gif.on('finished', blob => {
          statusText.textContent = 'GIF ready! Download starting...';
          progressBar.value = 100;
          resolve(blob);
        });

        captureFrame();
      });

      video.onerror = () => reject('Failed to load video.');
    });
  }

  // Event handlers for conversion buttons

  toGifBtn.addEventListener('click', async () => {
    toGifBtn.disabled = true;
    toLottieBtn.disabled = true;
    toVideoBtn.disabled = true;
    progressWrap.style.display = 'block';
    progressBar.value = 0;
    statusText.textContent = 'Converting to GIF...';

    try {
      if (fileType === 'gif') {
        alert('You already uploaded a GIF.');
      } else if (fileType === 'json') {
        alert('Lottie to GIF conversion not supported client-side.');
      } else if (['mp4','webm','mov','avi','mkv'].includes(fileType)) {
        const gifBlob = await videoToGif(fileData);
        gifPreview.src = URL.createObjectURL(gifBlob);
        gifPreview.style.display = 'block';
        autoDownload(gifBlob, (fileNameInput.value || 'animation') + '.gif');
      } else {
        alert('Unsupported file for GIF conversion.');
      }
    } catch (e) {
      alert('GIF conversion failed: ' + e);
    } finally {
      toGifBtn.disabled = false;
      toLottieBtn.disabled = false;
      toVideoBtn.disabled = false;
      progressWrap.style.display = 'none';
    }
  });

  toLottieBtn.addEventListener('click', () => {
    alert('Lottie conversion from video or GIF requires backend processing.');
  });

  toVideoBtn.addEventListener('click', () => {
    alert('Video conversion functionality coming soon.');
  });

  resetBtn.addEventListener('click', () => {
    fileInput.value = '';
    fileNameInput.value = 'animation';
    frameCountInput.value = 15;
    scaleInput.value = 50;
    resetAll();
  });

</script>
<script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.min.js"></script>
</body>
</html>
