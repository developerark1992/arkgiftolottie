<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GIF → One-Click Lottie</title>

  <!-- Favicon from repo root -->
  <link rel="icon" type="image/png" href="favicon.png" />

  <style>
    body {
      background: #121212;
      color: #e0e0e0;
      display: flex;
      justify-content: center;
      padding-top: 2rem;
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      background: #1e1e1e;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      padding: 2rem;
      width: 90%;
      max-width: 700px;
    }
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    .profile-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-right: 0.75rem;
      border: 2px solid #2196f3;
    }
    h2, h3 {
      margin: 0 0 1rem;
      color: #fafafa;
    }
    .section {
      margin-bottom: 1.5rem;
    }
    input, button {
      font-size: 1rem;
      margin-right: 0.5rem;
    }
    input[type="text"],
    input[type="number"] {
      padding: 0.4rem;
      border-radius: 4px;
      border: 1px solid #555;
      background: #2b2b2b;
      color: #fff;
    }
    button {
      background: #2196f3;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      padding: 0.6rem 1.2rem;
      transition: background 0.2s;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #1976d2;
    }
    img, #lottieContainer {
      display: block;
      margin: 0.5rem 0;
      width: 100%;
      border: 1px solid #333;
      border-radius: 6px;
      background: transparent;
    }
    #lottieContainer {
      height: 300px;
      background: #000;
    }
    .footer {
      margin-top: 2rem;
      font-size: 0.9rem;
      text-align: center;
      color: #888;
    }
    .footer a {
      color: #2196f3;
      text-decoration: none;
    }
  </style>
</head>
<body>

  <div class="card">
    <div class="header">
      <img src="favicon.png" alt="Abdul Rehman Khan" class="profile-icon" />
      <h2>GIF → One-Click Lottie</h2>
    </div>

    <div class="section">
      <input type="file" id="gifInput" accept="image/gif" />
      <input type="text" id="fileName" placeholder="Base filename" value="animation" />
      <button id="convertBtn" disabled>Convert to Lottie</button>
    </div>

    <div class="section">
      <h3>Preview</h3>
      <div id="lottieContainer"></div>
      <button id="downloadJSON" disabled>Download JSON</button>
    </div>

    <div class="footer">
      Created by Abdul Rehman Khan —  
      <a href="https://www.linkedin.com/in/developerark/" target="_blank">
        LinkedIn Profile
      </a>
    </div>
  </div>

  <script type="module">
    import { parseGIF, decompressFrames } from 'https://esm.sh/gifuct-js@2.1.2';
    import lottie from 'https://esm.sh/lottie-web';

    const gifInput    = document.getElementById('gifInput');
    const fileNameIn  = document.getElementById('fileName');
    const convertBtn  = document.getElementById('convertBtn');
    const lottieCont  = document.getElementById('lottieContainer');
    const downloadBtn = document.getElementById('downloadJSON');

    let gifFrames = [];
    let lottieData = null;
    const videoMime = 'video/webm; codecs=vp8,opus';
    const fps = 30;

    // Enable button once GIF is loaded & frames extracted
    gifInput.addEventListener('change', async () => {
      const file = gifInput.files[0];
      if (!file) return convertBtn.disabled = true;
      const buffer = await file.arrayBuffer();
      const parsed = parseGIF(buffer);
      gifFrames = decompressFrames(parsed, true);
      convertBtn.disabled = !gifFrames.length;
    });

    convertBtn.addEventListener('click', async () => {
      convertBtn.disabled = true;
      downloadBtn.disabled = true;

      // 1) Record in-memory transparent WebM
      const webmBlob = await recordWebM(gifFrames, fps);

      // 2) Build Lottie JSON from that WebM
      lottieData = await webmToLottie(webmBlob, fps);

      // 3) Preview & enable download
      lottieCont.innerHTML = '';
      lottie.loadAnimation({
        container:    lottieCont,
        renderer:     'svg',
        loop:         true,
        autoplay:     true,
        animationData: lottieData
      });
      downloadBtn.disabled = false;
    });

    downloadBtn.addEventListener('click', () => {
      if (!lottieData) return;
      const base = (fileNameIn.value || 'animation').trim();
      const blob = new Blob([JSON.stringify(lottieData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = base + '.json';
      a.click();
    });

    // Helper to record WebM
    function recordWebM(frames, fps) {
      return new Promise(res => {
        const canvas = document.createElement('canvas');
        canvas.width = frames[0].dims.width;
        canvas.height = frames[0].dims.height;
        const ctx = canvas.getContext('2d');

        const stream = canvas.captureStream(fps);
        const rec = new MediaRecorder(stream, { mimeType: videoMime });
        const chunks = [];
        rec.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };
        rec.onstop = () => res(new Blob(chunks, { type: videoMime }));
        rec.start();

        let i = 0, delay = 1000 / fps;
        (function draw() {
          if (i >= frames.length) return rec.stop();
          const f = frames[i++];
          ctx.putImageData(new ImageData(
            new Uint8ClampedArray(f.patch),
            f.dims.width, f.dims.height
          ), 0, 0);
          setTimeout(draw, delay);
        })();
      });
    }

    // Helper to convert WebM → Lottie
    async function webmToLottie(blob, fps) {
      const vid = document.createElement('video');
      vid.src = URL.createObjectURL(blob);
      vid.muted = true;
      vid.playsInline = true;
      await vid.play().catch(() => {});
      vid.pause();

      // Wait for metadata
      await new Promise(r => {
        if (vid.readyState >= 1) return r();
        vid.addEventListener('loadedmetadata', r, { once: true });
      });

      const duration = vid.duration;
      const totalFrames = Math.min(gifFrames.length, fps);
      const canvas = document.createElement('canvas');
      canvas.width = vid.videoWidth;
      canvas.height = vid.videoHeight;
      const ctx = canvas.getContext('2d');

      const images = [];
      for (let i = 0; i < totalFrames; i++) {
        vid.currentTime = (i / totalFrames) * duration;
        await new Promise(r => vid.onseeked = r);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(vid, 0, 0);
        images.push(canvas.toDataURL('image/png'));
      }

      const assets = images.map((d, i) => ({
        id: `img_${i}`, w: canvas.width, h: canvas.height, p: d, e: 1
      }));
      const layers = images.map((_, i) => ({
        ddd: 0, ind: i+1, ty: 2, refId: `img_${i}`,
        ks: {
          o: { a:0, k:100 }, r:{ a:0, k:0 },
          p: { a:0, k:[canvas.width/2, canvas.height/2, 0] },
          a: { a:0, k:[canvas.width/2, canvas.height/2, 0] },
          s: { a:0, k:[100,100,100] }
        },
        ip: i, op: i+1, st: 0, bm: 0
      }));

      return {
        v: "5.7.4",
        fr: fps,
        ip: 0,
        op: images.length,
        w: canvas.width,
        h: canvas.height,
        nm: "One-Click Lottie",
        ddd: 0,
        assets,
        layers
      };
    }
  </script>
</body>
</html>
