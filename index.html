<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GIF ➜ Lottie JSON (AUTO Small & Clean)</title>
<style>
  :root { color-scheme: dark; }
  body { background:#121212; color:#e0e0e0; font-family: system-ui, -apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; margin:0; padding:2rem; display:flex; justify-content:center; }
  .card { width:min(980px,96vw); background:#1e1e1e; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.45); padding:22px; }
  h2 { margin:.25rem 0 1rem; color:#fafafa }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center }
  .section { margin:1rem 0 }
  input[type="text"] { background:#2a2a2a; color:#fff; border:1px solid #444; border-radius:8px; padding:.48rem .6rem; font-size:15px; }
  button { background:#2196f3; color:#fff; border:0; border-radius:10px; padding:.6rem 1.1rem; font-weight:600; cursor:pointer; }
  button:disabled { background:#555; cursor:not-allowed }
  button:hover:not(:disabled) { background:#1976d2 }
  .preview { border:1px solid #333; border-radius:10px; height:380px; background:#121212; }
  .hint { color:#aaa; font-size:.92rem }
  .danger { color:#ff7676 }
  progress { width:260px; height:10px }
  .kv { display:inline-block; min-width:120px; color:#bbb }
</style>
</head>
<body>
  <div class="card">
    <h2>GIF ➜ Lottie JSON (AUTO — WebP Small & Clean)</h2>

    <div class="section row">
      <input id="fileInput" type="file" accept=".gif" />
      <input id="baseName" type="text" value="animation" placeholder="Base filename" />
      <button id="convertBtn" disabled>Convert to JSON</button>
      <button id="resetBtn">Reset</button>
    </div>

    <div class="section">
      <div id="status" class="hint">Load a GIF to begin.</div>
    </div>

    <div class="section row" id="progressWrap" style="display:none">
      <span class="kv" id="progLabel">Encoding…</span>
      <progress id="prog" max="100" value="0"></progress>
      <span class="kv" id="progDetail"></span>
    </div>

    <div class="section">
      <h3 style="margin:.25rem 0 .5rem">Preview</h3>
      <div id="lottieContainer" class="preview"></div>
    </div>
  </div>

<script type="module">
import { parseGIF, decompressFrames } from 'https://esm.sh/gifuct-js@2.1.2';
import lottie from 'https://esm.sh/lottie-web';

/* ---------- Elements ---------- */
const $ = id => document.getElementById(id);
const fileInput   = $('fileInput');
const baseName    = $('baseName');
const convertBtn  = $('convertBtn');
const resetBtn    = $('resetBtn');
const lottieDiv   = $('lottieContainer');
const statusEl    = $('status');
const progWrap    = $('progressWrap');
const prog        = $('prog');
const progLabel   = $('progLabel');
const progDetail  = $('progDetail');

/* ---------- State ---------- */
let gifFrames = null;
let parsedGif = null;
let gifW = 0, gifH = 0;
let lottiePlayer = null;

/* ---------- UI helpers ---------- */
function setStatus(msg, isError=false){
  statusEl.textContent = msg;
  statusEl.className = isError ? 'hint danger' : 'hint';
}
function resetPreview(){
  lottieDiv.innerHTML = '';
  if (lottiePlayer) { try { lottiePlayer.destroy(); } catch(_){} lottiePlayer = null; }
}
function resetAll(){
  gifFrames = null; parsedGif = null; gifW=0; gifH=0;
  convertBtn.disabled = true;
  setStatus('Load a GIF to begin.');
  resetPreview();
  fileInput.value = '';
  showProgress(false);
}
resetBtn.addEventListener('click', resetAll);

function showProgress(show, label='', val=0, detail=''){
  progWrap.style.display = show ? 'flex' : 'none';
  if (show){ prog.value = val; progLabel.textContent = label; progDetail.textContent = detail || ''; }
}

/* ---------- Load GIF ---------- */
fileInput.addEventListener('change', async () => {
  resetPreview();
  const f = fileInput.files?.[0];
  if (!f) return;
  if (f.size > 200 * 1024 * 1024) {
    setStatus('File too large (max 200 MB).', true);
    fileInput.value = '';
    return;
  }
  try {
    setStatus('Parsing GIF…');
    const buf = await f.arrayBuffer();
    parsedGif = parseGIF(buf);
    gifFrames = decompressFrames(parsedGif, true);
    gifW = parsedGif.lsd.width;
    gifH = parsedGif.lsd.height;
    convertBtn.disabled = !gifFrames?.length;
    setStatus(`Loaded ${gifFrames.length} frames (${gifW}×${gifH}). Auto set: WebP q=0.95, no quantize, no keying.`);
  } catch (e) {
    console.error(e);
    setStatus('Failed to read GIF.', true);
    convertBtn.disabled = true;
  }
});

/* ---------- Convert ---------- */
convertBtn.addEventListener('click', async () => {
  if (!gifFrames?.length) return;
  convertBtn.disabled = true;
  setStatus('Converting to JSON…');
  showProgress(true, 'Encoding…', 0);

  try {
    const json = await gifToLottie(gifFrames, {
      w: gifW, h: gifH,
      format: 'webp', quality: 0.95,   // auto defaults
      onProgress: (stage,i,total)=> {
        if (stage==='encode') showProgress(true,'Encoding frames…',Math.round((i/total)*90),`${i}/${total}`);
      }
    });

    // Preview
    resetPreview();
    lottiePlayer = lottie.loadAnimation({
      container: lottieDiv, renderer:'canvas', loop:true, autoplay:true, animationData:json
    });

    // Download
    const name = (baseName.value || 'animation')+'.json';
    const blob = new Blob([JSON.stringify(json,null,2)], { type:'application/json' });
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name;
    document.body.appendChild(a); a.click(); a.remove();

    setStatus(`Done. JSON size ~ ${(JSON.stringify(json).length/1024).toFixed(0)} KB.`);
  } catch (e) {
    console.error(e);
    setStatus('Conversion failed.', true);
  } finally {
    convertBtn.disabled=false; showProgress(false);
  }
});

/* ---------- Conversion ---------- */
async function gifToLottie(frames, opts){
  const {w,h,format,quality,onProgress} = opts;
  const delays = frames.map(f=>(f.delay||10)*10);
  const canvases = [];

  // Compose
  frames.forEach((f,i)=>{
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    const ctx=c.getContext('2d'); ctx.putImageData(new ImageData(new Uint8ClampedArray(f.patch),f.dims.width,f.dims.height),f.dims.left,f.dims.top);
    canvases.push(c);
  });

  // Encode frames
  const dataURLs=[];
  for(let i=0;i<canvases.length;i++){
    const url = await new Promise(res=>canvases[i].toBlob(b=>{
      const r=new FileReader(); r.onload=()=>res(r.result);
      r.readAsDataURL(b);
    },'image/webp',quality));
    dataURLs.push(url);
    onProgress && onProgress('encode',i+1,canvases.length);
  }

  // Assemble JSON
  const fr=30; let t=0; const assets=[],layers=[];
  for(let i=0;i<dataURLs.length;i++){
    const id=`img_${i}`;
    assets.push({id,w,h,p:dataURLs[i],e:1});
    const ip=Math.round((t/1000)*fr);
    const op=Math.round(((t+delays[i])/1000)*fr);
    layers.push({ddd:0,ind:i+1,ty:2,refId:id,
      ks:{o:{a:0,k:100},r:{a:0,k:0},p:{a:0,k:[w/2,h/2,0]},a:{a:0,k:[w/2,h/2,0]},s:{a:0,k:[100,100,100]}},
      ip,op,st:0,bm:0});
    t+=delays[i];
  }
  return {v:"5.7.4",fr,ip:0,op:layers[layers.length-1].op,w,h,nm:"GIF2Lottie (WebP 0.95)",ddd:0,assets,layers};
}
</script>
</body>
</html>
